---
import { getCollection } from 'astro:content';
import Head from '../../components/Head.vue';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.vue';
import { config_site } from '../../utils/config-adapter';
import '../../../src/styles/global.styl';
import { processFrontmatter } from '../../utils/process-frontmatter';
import dayjs from 'dayjs';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const processedPosts = await Promise.all(allPosts.map(post => processFrontmatter(post)));

  // 提取所有唯一标签
  const allTags = new Set();
  processedPosts.forEach(post => {
    const tags = post.data.tags || [];
    tags.forEach(tag:any => {
      if (tag.trim()) {
        allTags.add(tag);
      }
    });
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const allPosts = await getCollection('posts');
const processedPosts = await Promise.all(allPosts.map(post => processFrontmatter(post)));

// 过滤包含此标签的文章
const taggedPosts = processedPosts.filter(post => 
  (post.data.tags || []).includes(tag)
).sort((a, b) => {
  // 按日期降序排序
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA;
});

// 页面标题
const pageTitle = `标签: ${tag} | ${config_site.title}`;
---

<!DOCTYPE html>
<html lang={config_site.lang}>
  <Head 
    title={pageTitle}
    description={`"${tag}" 标签相关的所有文章`}
    author={config_site.author}
    url={config_site.url + '/tags/' + tag}
  >
    <!-- 添加 noindex 元标记，防止搜索引擎索引 -->
    <meta name="robots" content="noindex, nofollow" slot="head" />
  </Head>
  <body>
    <script>
      import '../../scripts/background.ts';
    </script>
    <Header />
    <main class="tag-detail-container">
      <div class="page-header">
        <h1 class="page-title">
          <span class="tag-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
          </span>
          {tag}
        </h1>
        <p class="page-description">共找到 {taggedPosts.length} 篇相关文章</p>
        <a href="/tags/" class="back-link">返回标签云</a>
      </div>

      <div class="post-list-container">
        {taggedPosts.length > 0 ? (
          <ul class="post-list">
            {taggedPosts.map(post => (
              <li class="post-item">
                <a href={`/posts/${post.data.abbrlink}/`} class="post-link">
                  <div class="post-date">
                    {dayjs(post.data.date).format('YYYY-MM-DD')}
                  </div>
                  <h2 class="post-title">{post.data.title}</h2>
                </a>
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="post-tags">
                    {post.data.tags.map(postTag:any => (
                      <a href={`/tags/${postTag}`} class={`post-tag ${postTag === tag ? 'current' : ''}`}>
                        {postTag}
                      </a>
                    ))}
                  </div>
                )}
              </li>
            ))}
          </ul>
        ) : (
          <div class="no-posts">未找到与标签 "{tag}" 相关的文章</div>
        )}
      </div>
    </main>
    <Footer />
  </body>
</html>

<style lang="stylus">
.tag-detail-container {
  max-width: 1200px
  margin: 0 auto
  padding: 2rem 1rem
  min-height: calc(100vh - 200px)
}

.page-header {
  text-align: center
  margin-bottom: 3rem
  
  .page-title {
    display: flex
    align-items: center
    justify-content: center
    font-size: 2.5rem
    margin-bottom: 1rem
    background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(1, 162, 190, 0.9))
    -webkit-background-clip: text
    -webkit-text-fill-color: transparent
    background-clip: text
  }
  
  .tag-icon {
    display: inline-flex
    margin-right: 0.5rem
    color: rgba(1, 162, 190, 0.9)
    stroke: currentColor
  }
  
  .page-description {
    font-size: 1.1rem
    color: rgba(255, 255, 255, 0.8)
    max-width: 600px
    margin: 0 auto 1rem
  }
  
  .back-link {
    display: inline-block
    padding: 0.4rem 1rem
    border-radius: 2rem
    background-color: rgba(255, 255, 255, 0.1)
    color: #ffffff
    text-decoration: none
    transition: all 0.3s ease
    font-size: 0.9rem
    
    &:hover {
      background-color: rgba(1, 162, 190, 0.2)
      transform: translateY(-2px)
    }
  }
}

.post-list-container {
  max-width: 900px
  margin: 0 auto
  padding: 1rem
}

.post-list {
  list-style: none
  padding: 0
  margin: 0
}

.post-item {
  margin-bottom: 1.5rem
  padding: 1.5rem
  background-color: rgba(255, 255, 255, 0.05)
  border-radius: 0.5rem
  transition: all 0.3s ease
  
  &:hover {
    background-color: rgba(255, 255, 255, 0.1)
    transform: translateY(-3px)
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2)
  }
}

.post-link {
  display: block
  text-decoration: none
  color: #ffffff
  margin-bottom: 0.8rem
}

.post-date {
  color: rgba(1, 162, 190, 0.9)
  font-size: 0.9rem
  margin-bottom: 0.5rem
}

.post-title {
  font-size: 1.4rem
  margin: 0
  line-height: 1.3
  transition: color 0.2s
  
  &:hover {
    color: rgba(1, 162, 190, 0.9)
  }
}

.post-tags {
  display: flex
  flex-wrap: wrap
  gap: 0.5rem
  margin-top: 1rem
}

.post-tag {
  font-size: 0.8rem
  padding: 0.25rem 0.6rem
  background-color: rgba(255, 255, 255, 0.1)
  border-radius: 1rem
  color: rgba(255, 255, 255, 0.8)
  text-decoration: none
  transition: all 0.2s
  
  &:hover {
    background-color: rgba(1, 162, 190, 0.2)
    color: #ffffff
  }
  
  &.current {
    background-color: rgba(1, 162, 190, 0.3)
    color: #ffffff
  }
}

.no-posts {
  text-align: center
  padding: 3rem 1rem
  color: rgba(255, 255, 255, 0.7)
  font-size: 1.2rem
  background-color: rgba(0, 0, 0, 0.1)
  border-radius: 0.5rem
}

@media (max-width: 768px) {
  .page-header {
    .page-title {
      font-size: 2rem
    }
    
    .page-description {
      font-size: 1rem
    }
  }
  
  .post-list-container {
    padding: 0.5rem
  }
  
  .post-item {
    padding: 1.2rem
    margin-bottom: 1rem
  }
  
  .post-title {
    font-size: 1.2rem
  }
}

@media (max-width: 480px) {
  .tag-detail-container {
    padding: 1.5rem 0.8rem
  }
  
  .page-header {
    margin-bottom: 2rem
    
    .page-title {
      font-size: 1.6rem
    }
  }
  
  .post-item {
    padding: 1rem
  }
  
  .post-title {
    font-size: 1.1rem
  }
}
</style>